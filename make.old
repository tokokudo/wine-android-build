#!/bin/bash
set -e

WINE_COMMIT="$1"
WINE_VERSION="$2"
WINE_BASE_APK_VERSION="7.0-rc6"

export ANDROID_HOME="$(pwd)/android"
export NDK_ROOT="$ANDROID_HOME/android-ndk-r17c"

export TOOLCHAIN_VERSION="arm"
export TOOLCHAIN_TRIPLE="arm-linux-androideabi"
export ANDROID_API=21

export ANDROID_CC=clang
export ANDROID_CXX=clang++

mkdir -p android
cd android

wget -nc https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip
unzip -n commandlinetools-linux-7583922_latest.zip > /dev/null

wget -nc https://dl.google.com/android/repository/android-ndk-r17c-linux-x86_64.zip
unzip -n android-ndk-r17c-linux-x86_64.zip > /dev/null

chmod +x cmdline-tools/bin/sdkmanager
yes | cmdline-tools/bin/sdkmanager --sdk_root="$(pwd)" \
  --install "build-tools;27.0.3" "tools" "platforms;android-25" "platform-tools" > /dev/null
yes | cmdline-tools/bin/sdkmanager --sdk_root="$(pwd)" --licenses > /dev/null

cd ..

wget -nc https://github.com/pxb1988/dex2jar/releases/download/v2.1/dex2jar-2.1.zip
unzip -n dex2jar-2.1.zip > /dev/null

mkdir -p apktool
cd apktool
wget -nc https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.6.0.jar -O apktool.jar
wget -nc https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O apktool
chmod +x apktool
cd ..

wget -nc https://dl.winehq.org/wine-builds/android/wine-${WINE_BASE_APK_VERSION}-arm.apk -O wine-vanilla.apk

mkdir -p build
cd build

$NDK_ROOT/build/tools/make-standalone-toolchain.sh \
  --platform=android-$ANDROID_API \
  --arch=arm \
  --install-dir=android-toolchain

export PATH="$(pwd)/android-toolchain/bin:$PATH"

wget -nc https://github.com/wine-mirror/wine/archive/$WINE_COMMIT.zip -O wine.zip
unzip wine.zip
mv wine-$WINE_COMMIT wine
cp -r wine wine-native

cd wine-native
unset CC
unset CXX
./configure --disable-win64
make -j$(nproc)
cd ..

wget -nc https://download.savannah.gnu.org/releases/freetype/freetype-2.11.1.tar.xz
tar xf freetype-2.11.1.tar.xz

cd freetype-2.11.1
./configure \
  --host=$TOOLCHAIN_TRIPLE \
  --prefix="$(pwd)/output" \
  --without-zlib \
  --with-png=no \
  --with-brotli=no \
  --with-harfbuzz=no \
  CC=$ANDROID_CC \
  CXX=$ANDROID_CXX
make -j$(nproc)
make install
cd ..

export FREETYPE_CFLAGS="-I$(pwd)/freetype-2.11.1/output/include/freetype2"
export FREETYPE_LIBS="-L$(pwd)/freetype-2.11.1/output/lib"

cd wine
./configure \
  --host=$TOOLCHAIN_TRIPLE \
  host_alias=$TOOLCHAIN_TRIPLE \
  --with-wine-tools=../wine-native \
  --prefix="$(pwd)/dlls/wineandroid.drv/assets" \
  --disable-win64 \
  --without-x \
  --without-wayland \
  --without-pulse \
  --without-alsa \
  --without-oss \
  --without-capi \
  --without-sdl \
  --without-gphoto \
  --without-sane \
  --without-udev \
  CC=$ANDROID_CC \
  CXX=$ANDROID_CXX

autoreconf
make -j$(nproc)
make install

cd dlls/wineandroid.drv
make clean
make
cd ../../../..

cp wine-vanilla.apk wine-patched.apk
bash gimmeapk .
unzip wine-debug.apk classes.dex
dex-tools-2.1/d2j-dex2jar.sh -f -o fresh-build.jar classes.dex
rm classes.dex
bash replaceclasses.sh wine-patched.apk fresh-build.jar org/winehq/wine
rm fresh-build.jar

echo "wine-patched.apk"
